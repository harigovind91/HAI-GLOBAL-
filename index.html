<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAI Global | Universal Intelligence Grid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <style>
        :root { --hai-red: #dc2626; --hai-green: #16a34a; }
        .side-menu { position: fixed; top: 0; left: -100%; width: 320px; height: 100%; background: white; z-index: 1000; transition: 0.5s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 25px 0 50px rgba(0,0,0,0.2); }
        .side-menu.active { left: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; backdrop-filter: blur(8px); }
        .menu-overlay.active { display: block; }
        .nav-gradient { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .glass-card:hover { transform: translateY(-5px); border-color: #dc2626; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; transition: 0.3s; font-weight: 700; color: #1e293b; font-size: 13px; }
        .menu-item:hover { background: #fef2f2; color: #dc2626; transform: translateX(8px); }
        .fresh-tag { background: linear-gradient(90deg, #16a34a, #22c55e); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: 900; }
        .ad-badge { background: gold; color: black; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 900; position: absolute; top: 10px; right: 10px; z-index: 10; }
        .world-grid { background-image: url('https://www.transparenttextures.com/patterns/world-map.png'); background-color: #f8fafc; }
        /* New Styles for Auth & Global States */
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .nearby-glow { box-shadow: 0 0 20px rgba(22, 163, 74, 0.3); border: 2px solid #16a34a !important; }
    </style>
</head>
<body class="world-grid font-sans text-slate-900">

    <div id="auth-modal" class="auth-overlay">
        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-md shadow-2xl text-center">
            <h2 class="text-2xl font-black italic mb-6">HAI <span class="text-red-600">SECURE LOGIN</span></h2>
            <div class="flex gap-2 mb-6 bg-gray-100 p-2 rounded-2xl">
                <button onclick="setRole('user')" id="btn-user" class="flex-1 p-2 rounded-xl text-[10px] font-bold bg-white shadow-sm border border-red-200">USER</button>
                <button onclick="setRole('seller')" id="btn-seller" class="flex-1 p-2 rounded-xl text-[10px] font-bold">SELLER</button>
                <button onclick="setRole('rider')" id="btn-rider" class="flex-1 p-2 rounded-xl text-[10px] font-bold">RIDER</button>
            </div>
            <input type="text" id="auth-contact" placeholder="Email or Mobile" class="w-full p-4 rounded-2xl bg-gray-50 border mb-4 focus:ring-2 focus:ring-red-600 outline-none">
            <button onclick="sendOTP()" class="w-full bg-black text-white p-4 rounded-2xl font-black mb-4">GET OTP</button>
            <div id="otp-box" class="hidden">
                <input type="text" id="otp-val" placeholder="771771" class="w-full p-4 rounded-2xl bg-gray-50 border mb-4 text-center font-bold tracking-[1em]">
                <button onclick="verifyLogin()" class="w-full bg-red-600 text-white p-4 rounded-2xl font-black">VERIFY & SIGNUP</button>
            </div>
            <button onclick="googleAuth()" class="mt-4 flex items-center justify-center gap-3 w-full border p-4 rounded-2xl font-bold text-sm">
                <img src="https://www.google.com/favicon.ico" class="w-4"> Continue with Google
            </button>
            <p onclick="closeAuth()" class="mt-6 text-[10px] font-bold text-gray-400 cursor-pointer">CANCEL ACCESS</p>
        </div>
    </div>

    <nav class="nav-gradient text-white p-4 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-5">
                <button onclick="toggleMenu()" class="text-3xl hover:rotate-90 transition-transform duration-300">‚ò∞</button>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter italic leading-none">HAI<span class="text-green-400">GLOBAL</span></h1>
                    <p class="text-[9px] font-bold tracking-[0.2em] text-red-100 uppercase">Universal Intelligence Grid</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 bg-black/20 p-2 rounded-xl border border-white/10">
                <div class="text-right hidden md:block" onclick="openAuth()">
                    <p id="user-city" class="text-[10px] font-black uppercase tracking-tighter italic">Locating Node...</p>
                    <p id="user-ip" class="text-[8px] font-medium opacity-70">IP: Fetching...</p>
                </div>
                <div id="currency-flag" class="text-2xl shadow-lg cursor-pointer" onclick="openAuth()">üåç</div>
            </div>
        </div>
    </nav>

    <div id="overlay" class="menu-overlay" onclick="toggleMenu()"></div>
    <div id="menu" class="side-menu flex flex-col">
        <div class="bg-slate-900 p-8 text-white">
            <h2 class="text-2xl font-black italic">HAI<span class="text-red-500">MENU</span></h2>
        </div>
        <div class="p-4 space-y-1 flex-grow overflow-y-auto">
            <div id="google_translate_element" class="mb-4"></div>
            <a href="#" onclick="routeToDashboard()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold block text-center mt-2">üë§ MY DASHBOARD</a>
            <p class="text-[10px] text-green-600 font-black px-3 mt-6 mb-2 tracking-widest uppercase border-b pb-1">Merchant Engine</p>
            <a href="merchant-registration.html" class="menu-item"><span>üè™</span> Seller Registration</a>
            <a href="merchant-portal.html" class="menu-item"><span>üöÄ</span> Merchant Portal</a>
            <p class="text-[10px] text-orange-600 font-black px-3 mt-6 mb-2 tracking-widest uppercase border-b pb-1">Logistic Node</p>
            <a href="delivery-boy.html" class="menu-item"><span>üèçÔ∏è</span> Rider Dashboard</a>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4">
        <div class="my-8 text-center md:text-left flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h2 class="text-4xl font-black text-slate-900 leading-none">GLOBAL <span class="text-red-600 underline italic">FRESH</span> GRID</h2>
                <p class="text-gray-500 font-medium mt-2 italic">HAI Ad-Engine & Location Logic Active.</p>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4">
                <div id="status-indicator" class="flex items-center gap-2 px-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p id="order-count" class="text-[10px] font-bold text-slate-700 font-black tracking-tighter">AI NODE CONNECTED</p>
                </div>
            </div>
        </div>

        <div id="product-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
            <p class='col-span-full text-center italic opacity-50 py-20'>Accessing HAI Cloud Nodes...</p>
        </div>
    </main>

    <script src="logic.js"></script>
    <script>
        const HAI_CONFIG = {
            adminUpi: "harigovindsingh91-2@okhdfcbank",
            version: "3.5.0"
        };

        let activeRole = 'user';

        function toggleMenu() {
            document.getElementById('menu').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // --- ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§° ‡§ë‡§• ‡§≤‡•â‡§ú‡§ø‡§ï ---
        function openAuth() { document.getElementById('auth-modal').style.display = 'flex'; }
        function closeAuth() { document.getElementById('auth-modal').style.display = 'none'; }
        
        function setRole(role) {
            activeRole = role;
            ['user', 'seller', 'rider'].forEach(r => {
                document.getElementById('btn-'+r).className = `flex-1 p-2 rounded-xl text-[10px] font-bold ${r === role ? 'bg-white shadow-sm border border-red-200' : ''}`;
            });
        }

        function sendOTP() {
            if(!document.getElementById('auth-contact').value) return alert("Enter Contact Info");
            document.getElementById('otp-box').classList.remove('hidden');
            alert("Scientific OTP Sent! (Testing Node Bypass: 771771)");
        }

        function verifyLogin() {
            if(document.getElementById('otp-val').value === '771771') {
                const user = { contact: document.getElementById('auth-contact').value, role: activeRole, avatar: 'https://via.placeholder.com/150' };
                localStorage.setItem('hai_user', JSON.stringify(user));
                alert("Identity Verified! Welcome to HAI Global.");
                location.reload();
            }
        }

        function routeToDashboard() {
            const user = JSON.parse(localStorage.getItem('hai_user'));
            if(!user) return openAuth();
            const routes = { 'user': 'user-dashboard.html', 'seller': 'merchant-portal.html', 'rider': 'delivery-boy.html' };
            window.location.href = routes[user.role];
        }

        // --- ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü ‡§á‡§Ç‡§ú‡§® (Hybrid: Cloud + Local Listing) ---
        async function initLocalization() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                document.getElementById('user-city').innerText = `${data.city}, ${data.country_name}`;
                document.getElementById('user-ip').innerText = `IP: ${data.ip}`;
                localStorage.setItem('user_nearby_city', data.city);
                fetchLiveMarket();
            } catch (e) { fetchLiveMarket(); }
        }

        async function fetchLiveMarket() {
            const userCity = localStorage.getItem('user_nearby_city');
            const grid = document.getElementById('product-list');
            
            try {
                // 1. ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§°‡•á‡§ü‡§æ
                let cloudItems = [];
                try {
                    const response = await fetch('/api/connect');
                    cloudItems = await response.json();
                } catch(e) { console.log("Cloud Node Offline"); }

                // 2. ‡§∏‡•á‡§≤‡§∞ ‡§ï‡•Ä ‡§®‡§à ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó (Local Data)
                const localItems = JSON.parse(localStorage.getItem('hai_local_market')) || [];
                const combined = [...localItems, ...cloudItems];

                if(combined.length > 0) {
                    grid.innerHTML = "";
                    combined.sort((a,b) => a.isAd ? -1 : (a.seller.city === userCity ? -1 : 0));
                    
                    combined.forEach(item => {
                        const isNearby = item.seller.city === userCity;
                        grid.innerHTML += `
                            <div class="product-card glass-card p-4 relative rounded-3xl border ${isNearby ? 'nearby-glow' : 'border-white/10'}">
                                ${item.isAd ? '<span class="ad-badge">AD</span>' : ''}
                                ${isNearby ? '<span class="absolute -top-2 -right-2 bg-green-600 text-[7px] text-white px-2 py-1 rounded-full font-black">NEARBY</span>' : ''}
                                <div class="w-full h-32 mb-4 bg-white rounded-2xl overflow-hidden shadow-inner">
                                    <img src="${item.product.img}" class="w-full h-full object-cover">
                                </div>
                                <h3 class="font-black text-[10px] uppercase truncate">${item.product.name}</h3>
                                <p class="text-[7px] text-blue-600 font-bold italic">üìç ${item.seller.city}</p>
                                <div class="flex items-center justify-between mt-3 border-t pt-3">
                                    <span class="text-sm font-black text-green-700">‚Çπ${item.product.price}</span>
                                    <button onclick="executeSecureTrade('${item.product.id}', '${item.product.name}', ${item.product.price}, '${item.seller.shop}')" 
                                        class="bg-black text-white text-[8px] px-3 py-2 rounded-xl font-black uppercase">Buy Now</button>
                                </div>
                            </div>`;
                    });
                }
            } catch (e) { grid.innerHTML = "Grid Connectivity Error."; }
        }

        // --- ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§≤‡•â‡§ú‡§ø‡§ï ---
        function executeSecureTrade(id, name, price, shop) {
            // ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§î‡§∞ ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü
            let cart = JSON.parse(localStorage.getItem('hai_cart')) || [];
            cart.push({ id, name, price, shop, status: 'Ordered' });
            localStorage.setItem('hai_cart', JSON.stringify(cart));

            // ‡§∞‡§æ‡§á‡§°‡§∞ ‡§ï‡•ã ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§≠‡•á‡§ú‡§®‡§æ
            let tasks = JSON.parse(localStorage.getItem('hai_rider_tasks')) || [];
            tasks.unshift({ orderId: 'H-'+Date.now().toString().slice(-4), product: name, price, status: 'Pending' });
            localStorage.setItem('hai_rider_tasks', JSON.stringify(tasks));

            alert(`üîê Trade Success!\n\nUser: Added to Cart\nSeller: Sale Logged\nRider: Task Dispatched`);
            window.location.href = `upi://pay?pa=${HAI_CONFIG.adminUpi}&pn=HAI_ADMIN&am=${price}&tn=Order_${name}`;
        }

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
        }

        window.onload = initLocalization;
    </script>
</body>
</html>
