<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAI Global | Universal Intelligence Grid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <style>
        :root { --hai-red: #dc2626; --hai-green: #16a34a; }
        .side-menu { position: fixed; top: 0; left: -100%; width: 320px; height: 100%; background: white; z-index: 1000; transition: 0.5s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 25px 0 50px rgba(0,0,0,0.2); }
        .side-menu.active { left: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 999; backdrop-filter: blur(8px); }
        .menu-overlay.active { display: block; }
        .nav-gradient { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .glass-card:hover { transform: translateY(-5px); border-color: #dc2626; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; transition: 0.3s; font-weight: 700; color: #1e293b; font-size: 13px; }
        .menu-item:hover { background: #fef2f2; color: #dc2626; transform: translateX(8px); }
        .fresh-tag { background: linear-gradient(90deg, #16a34a, #22c55e); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: 900; }
        .ad-badge { background: gold; color: black; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 900; position: absolute; top: 10px; right: 10px; z-index: 10; }
        .world-grid { background-image: url('https://www.transparenttextures.com/patterns/world-map.png'); background-color: #f8fafc; }
    </style>
</head>
<body class="world-grid font-sans text-slate-900">

    <nav class="nav-gradient text-white p-4 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-5">
                <button onclick="toggleMenu()" class="text-3xl hover:rotate-90 transition-transform duration-300">‚ò∞</button>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter italic leading-none">HAI<span class="text-green-400">GLOBAL</span></h1>
                    <p class="text-[9px] font-bold tracking-[0.2em] text-red-100 uppercase">Universal Intelligence Grid</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 bg-black/20 p-2 rounded-xl border border-white/10">
                <div class="text-right hidden md:block">
                    <p id="user-city" class="text-[10px] font-black uppercase tracking-tighter italic">Locating Node...</p>
                    <p id="user-ip" class="text-[8px] font-medium opacity-70">IP: Fetching...</p>
                </div>
                <div id="currency-flag" class="text-2xl shadow-lg">üåç</div>
            </div>
        </div>
    </nav>

    <div id="overlay" class="menu-overlay" onclick="toggleMenu()"></div>
    <div id="menu" class="side-menu flex flex-col">
        <div class="bg-slate-900 p-8 text-white">
            <h2 class="text-2xl font-black italic">HAI<span class="text-red-500">MENU</span></h2>
        </div>
        <div class="p-4 space-y-1 flex-grow overflow-y-auto">
            <div id="google_translate_element" class="mb-4"></div>
            <a href="user-login.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold block text-center mt-2">üë§ MY DASHBOARD</a>
            <p class="text-[10px] text-green-600 font-black px-3 mt-6 mb-2 tracking-widest uppercase border-b pb-1">Merchant Engine</p>
            <a href="merchant-registration.html" class="menu-item"><span>üè™</span> Seller Registration</a>
            <a href="merchant-portal.html" class="menu-item"><span>üöÄ</span> Merchant Portal</a>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4">
        <div class="my-8 text-center md:text-left flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h2 class="text-4xl font-black text-slate-900 leading-none">GLOBAL <span class="text-red-600 underline italic">FRESH</span> GRID</h2>
                <p class="text-gray-500 font-medium mt-2 italic">HAI Ad-Engine & Location Logic Active.</p>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4">
                <div id="status-indicator" class="flex items-center gap-2 px-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p id="order-count" class="text-[10px] font-bold text-slate-700 font-black">AI NODE CONNECTED</p>
                </div>
            </div>
        </div>

        <div id="product-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
            </div>
    </main>

    <script>
        const HAI_CONFIG = {
            adminUpi: "harigovindsingh91-2@okhdfcbank",
            commissionRate: 0.10, 
            version: "2.2.0"
        };

        function toggleMenu() {
            document.getElementById('menu').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // --- ‡§µ‡•à‡§ú‡•ç‡§û‡§æ‡§®‡§ø‡§ï ‡§Ö‡§™‡§°‡•á‡§ü 1: ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ ‡§´‡•á‡§ö‡§ø‡§Ç‡§ó ---
        async function initLocalization() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                document.getElementById('user-city').innerText = `${data.city}, ${data.country_name}`;
                document.getElementById('user-ip').innerText = `IP: ${data.ip}`;
                
                const userNode = { city: data.city, zip: data.postal, country: data.country_name };
                localStorage.setItem('hai_last_node', JSON.stringify(userNode));

                // ‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏ ‡§≤‡§æ‡§®‡§æ
                fetchCloudMarket(userNode);
                refreshOrderCount();
            } catch (e) {
                console.error("Locality Error:", e);
                fetchCloudMarket({ city: 'Global' });
            }
        }

        // --- ‡§µ‡•à‡§ú‡•ç‡§û‡§æ‡§®‡§ø‡§ï ‡§Ö‡§™‡§°‡•á‡§ü 2: Ad-Engine & Proximity (‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡§¶‡§æ‡§∞) ---
        async function fetchCloudMarket(userNode) {
            const container = document.getElementById('product-list');
            container.innerHTML = "<p class='col-span-full text-center italic opacity-50'>Connecting to HAI Global Cloud...</p>";

            try {
                const response = await fetch('/api/connect'); // ‡§Ü‡§™‡§ï‡•Ä MongoDB API
                const allItems = await response.json();

                // ‡§è‡§≤‡•ç‡§ó‡•ã‡§∞‡§ø‡§•‡•ç‡§Æ: 1. ‡§™‡§π‡§≤‡•á Ads ‡§¶‡§ø‡§ñ‡§æ‡§ì, 2. ‡§´‡§ø‡§∞ ‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§∂‡§π‡§∞ ‡§ï‡•á ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏, 3. ‡§´‡§ø‡§∞ ‡§¨‡§æ‡§ï‡•Ä ‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ
                const sortedItems = allItems.sort((a, b) => {
                    if (a.isAd) return -1; // Ads ‡§∏‡§¨‡§∏‡•á ‡§ä‡§™‡§∞
                    if (a.seller.city === userNode.city) return -1; // ‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡•Å‡§ï‡§æ‡§®‡§¶‡§æ‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞
                    return 0;
                });

                container.innerHTML = sortedItems.map(item => `
                    <div class="product-card glass-card p-4 relative rounded-[2rem] border ${item.isAd ? 'border-yellow-400' : ''}">
                        ${item.isAd ? '<span class="ad-badge">SPONSORED</span>' : ''}
                        <span class="fresh-tag absolute top-4 left-4">LIVE FRESH</span>
                        <div class="w-full h-32 flex items-center justify-center mb-4 bg-white rounded-2xl overflow-hidden shadow-inner">
                            <img src="${item.product.img}" class="w-full h-full object-cover">
                        </div>
                        <h3 class="font-black text-[10px] uppercase truncate">${item.product.name}</h3>
                        <p class="text-[8px] text-gray-400 font-bold mb-1">${item.seller.shop}</p>
                        <p class="text-[7px] text-blue-600 font-black italic">üìç ${item.seller.city}</p>
                        <div class="flex items-center justify-between mt-3 border-t pt-3">
                            <span class="text-sm font-black text-green-700">‚Çπ${item.product.price}</span>
                            <button onclick="executeSecureTrade('${item.product.id}', '${item.product.name}', ${item.product.price})" 
                                class="bg-black text-white text-[8px] px-3 py-2 rounded-xl font-black hover:bg-red-600 transition uppercase">Buy Now</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                // ‡§´‡•á‡§≤ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§°‡§Æ‡•Ä ‡§°‡•á‡§ü‡§æ (Back-up)
                renderStaticProducts();
            }
        }

        // --- ‡§µ‡•à‡§ú‡•ç‡§û‡§æ‡§®‡§ø‡§ï ‡§Ö‡§™‡§°‡•á‡§ü 3: ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§∞‡§æ‡§â‡§ü‡§ø‡§Ç‡§ó ---
        function checkUserRoleAndRedirect() {
            const user = JSON.parse(localStorage.getItem('hai_user'));
            if(!user) {
                window.location.href = 'user-login.html';
                return;
            }
            // ‡§∞‡•ã‡§≤ ‡§ï‡•á ‡§π‡§ø‡§∏‡§æ‡§¨ ‡§∏‡•á ‡§∏‡§π‡•Ä ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
            if(user.role === 'seller') window.location.href = 'merchant-portal.html';
            else if(user.role === 'rider') window.location.href = 'delivery-boy.html';
            else window.location.href = 'user-dashboard.html';
        }

        // (‡§Ü‡§™‡§ï‡§æ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ executeSecureTrade ‡§î‡§∞ refreshOrderCount ‡§Ø‡§π‡§æ‡§Å ‡§Ø‡§•‡§æ‡§µ‡§§ ‡§∞‡§π‡•á‡§ó‡§æ)
        function executeSecureTrade(id, name, amount) {
            const orderId = "HAI-" + Math.floor(100000 + Math.random() * 900000);
            alert(`HAI SECURE GATEWAY\nOrder ID: ${orderId}\nProcessing...`);
            window.location.href = `upi://pay?pa=${HAI_CONFIG.adminUpi}&pn=HAI_ADMIN&am=${amount}&tn=Order_${orderId}`;
        }

        function refreshOrderCount() {
            const orders = JSON.parse(localStorage.getItem('hai_orders')) || [];
            document.getElementById('order-count').innerText = `${orders.length} ACTIVE TRADES`;
        }

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
        }

        window.onload = initLocalization;
    </script>
</body>
</html>
